worker_processes 1;

events {
  worker_connections 1024;
}

http {
  access_log off;

  map $request_method$http_access_control_request_private_network $cors_allow_private_network {
    "OPTIONStrue" "true";
    default "";
  }

  add_header Access-Control-Allow-Private-Network $cors_allow_private_network;

  upstream algod_api {
    zone upstreams 64K;
    server algod:8080 max_fails=1 fail_timeout=2s;
    keepalive 2;
  }

  upstream kmd_api {
    zone upstreams 64K;
    server algod:7833 max_fails=1 fail_timeout=2s;
    keepalive 2;
  }

  upstream indexer_api {
    zone upstreams 64K;
    server indexer:8980 max_fails=1 fail_timeout=2s;
    keepalive 2;
  }

  server {
    listen 4001;

    location / {
      proxy_set_header Host $host;
      proxy_pass http://algod_api;
      proxy_pass_header Server;
    }
  }

  server {
    listen 4002;

    location / {
      proxy_set_header Host $host;
      proxy_pass http://kmd_api;
      proxy_pass_header Server;
    }
  }

  server {
    listen 8980;

    location / {
      proxy_set_header Host $host;
      proxy_pass http://indexer_api;
      proxy_pass_header Server;
    }
  }
}
    
