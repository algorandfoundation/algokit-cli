name: Build, Test and Publish Python

on: [workflow_call]

jobs:
  build-python:
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "windows-latest", "macos-latest"]
        python: ["3.11"]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Install poetry
        run: pipx install poetry

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
          cache: "poetry"

      - name: Install dependencies
        run: poetry install --no-interaction

      # - name: pytest + coverage
      #   shell: bash
      #   run: |
      #     set -o pipefail
      #     poetry run pytest -n auto --junitxml=pytest-junit.xml --cov-report=term-missing:skip-covered --cov=src | tee pytest-coverage.txt

      # - name: pytest coverage comment - using Python 3.10 on ubuntu-latest
      #   if: matrix.python == '3.10' && matrix.os == 'ubuntu-latest'
      #   continue-on-error: true # forks fail to add a comment, so continue any way
      #   uses: MishaKav/pytest-coverage-comment@main
      #   with:
      #     pytest-coverage-path: ./pytest-coverage.txt
      #     junitxml-path: ./pytest-junit.xml

      - name: Install setuptools (3.12 only)
        if: matrix.python == '3.12' && matrix.os == 'windows-latest'
        run: poetry add setuptools

      - name: Build Exacutable
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: src/algokit
          onefile: true
          standalone: true
#          package_dir: .venv/Lib/${{ matrix.python }}/site-packages/
          enable-plugin: click

      - name: Test Executable
        run: |
          ls -l build
          ls -l build/algokit.dist
          build/algokit.dist/algokit --help

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: algokit-cli-${{ matrix.os }}-py${{ matrix.python }}
          path: |
            build/*.exe
            build/*.bin
